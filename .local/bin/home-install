#!/usr/bin/env bash
set -e

SCRIPT_DIR=$( cd -P "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )
LOCAL_DIR=$( dirname "$SCRIPT_DIR" )
REPO_DIR=$( dirname "$LOCAL_DIR" )

if
  [ $(basename "$SCRIPT_DIR") != bin ] &&
  [ $(basename "$LOCAL_DIR") != .local ]; then
  echo "home-install expected to be running from .local/bin/home-install" >&2
  exit 1
fi

DATA_DIR="$LOCAL_DIR/share/home-install"

setup_system() {
  dest=${1}
  do=${2:-sudo}
  if [ -d "$dest/etc/systemd" ] && [ -e "$dest/usr/lib/systemd/system/getty@.service" ]; then
    set -x
    $do install -D "$DATA_DIR/autologin.conf" "$dest/etc/systemd/system/getty@tty1.service.d/autologin.conf"
    $do systemctl add-wants getty.target getty@tty1.service
    set +x
  fi
}

confirm() {
  echo -n "$1? [y/N] "
  read yn
  case "$yn" in
    y*|Y*)
      ;;
    *)
      return 1
      ;;
  esac
}

setup_dest() {
  dest=${1:-$HOME}

  alter=$(
    if [ "$dest" != "$HOME" ]; then
      getent passwd | while IFS=: read name x uid guid gecos home shell; do
        if [ "$dest" == "$home" ]; then
          echo "$name"
          break
        fi
      done
    fi
  )

  nom=
  if [ -n "$alter" ]; then
    nom=".$alter"
  fi
  remote_name=${2:-local$nom}
  branch_name=${3:-local$nom}
  shared='false'

  if ! [ -O "$dest" ]; then
    if ! [ -w "$dest" ]; then
      echo "Unable to write to $dest" >&2
      return 1
    fi
    shared='group'
  fi

  echo "dest: $dest"
  echo "remote_name: $remote_name"
  echo "branch_name: $branch_name"
  echo "shared: $shared"
  confirm "deploy"
  echo "deploying..."

  if [ "$REPO_DIR" == "$dest" ]; then
    echo "Already running inside of $dest" >&2
    return 1
  fi

  set -x

  if ! [ -d "$dest/.git" ]; then
    pushd "$dest"
    [ -f .gitignore ] || cp "$REPO_DIR/.gitignore" .
    git init --initial-branch=prior --shared="$shared"
    git config --global --add safe.directory "$dest" # TODO only if needed; also dupe for target
    if [ "$shared" != "false" ]; then
      git config receive.denyNonFastForwards false
    fi
    git add .
    git commit -m "Add prior $dest files"
    popd
  fi

  if ! git remote get-url $remote_name >&/dev/null; then
    git remote add $remote_name "$dest"
    git fetch $remote_name
  fi

  if [ -n "$alter" ]; then
    if ! git rev-parse --verify $branch_name >/dev/null 2>&2; then
      create_alter "$alter"
    fi

    if [ $(git rev-parse "$branch_name") == $(git rev-parse local) ]; then
      git checkout $branch_name
      make_alter "$alter"
      git checkout -
    fi

  fi

  git push -u $remote_name $branch_name

  pushd "$dest"
  git checkout $branch_name
  "$SCRIPT_DIR/git-setup-worktree-push"
  popd

  set +x
}

create_alter() {
  alter=$1
  [ -n "$alter" ]
  branch_name=${2:-local.$alter}

  for start in alter local wip main; do
    if git rev-parse --verify $start >/dev/null 2>&2; then
      git branch "$branch_name" "$start"
      break
    fi
  done
}

make_alter() {
  alter=$1
  if [ -z "$alter" ]; then
    echo -n "alter name? "
    read alter
  fi

  home_remote=$(git --git-dir=$HOME/.git remote)
  home_int=$(git --git-dir=$HOME/.git remote get-url "$home_remote")
  cd "$home_int"

  branch_name="local.$alter" 
  head_branch=$(basename $(git symbolic-ref HEAD))
  if [ "$branch_name" != "$head_branch" ]; then
    if [ $(git rev-parse --verify "$branch_name" 2>/dev/null) ]; then
      git checkout "$branch_name"
    elif confirm "create branch $branch_name"; then
      create_alter "$alter" "$branch_name"
    else
      echo "NOTE: creating alter on current branch: $head_branch"
    fi
  fi

  sed -i .gitconfig \
    -e "/email *=/ s/@/+${alter}@/"
  git add .gitconfig

  sed -i .gitignore \
    -e '/ssh.config/ a !/.ssh/authorized_keys'
  git add .gitignore

  cat $(find ~/.ssh -name '*.pub' | head -n1) >> .ssh/authorized_keys
  git add .ssh/authorized_keys

  git commit -m "LOCAL.${alter}: init alter"
}

just() {
  "$@"
}

usage() {
  echo "usage: home-install system"
  echo "       home-install test-system"
  echo "       home-install deploy [dest [name] [start]]"
  echo "       home-install make-alter [<name>]"
}

case "$1" in
  test-system)
    fake=$(mktemp -t -d system.XXX)
    echo "=== Testing home-install system setup in $fake"
    set -x

    install -d "$fake/etc/systemd"
    install -d "$fake/usr/lib/systemd/system"
    echo 'nonesense' > "$fake/usr/lib/systemd/system/getty@.service"

    setup_system "$fake" just
    ;;

  system)
    setup_system
    ;;

  deploy)
    shift
    setup_dest "$@"
    ;;

  make-alter)
    shift
    # TODO ensure branch?
    make_alter "$1"
    ;;

  *)
    usage >&2
    ;;

esac
