#!/bin/bash
set -e

# A Less Crude Personal Package Manager
# http://nullprogram.com/blog/2018/03/27/
# FIXME documentation / help / etc

die() {
	echo "$@" >&2
	exit 1
}

inspectPackage() {
	PREFIX=$PKGROOT
	SRCDIR=$1
	PKGNAME=$(basename "$SRCDIR")

	PKGHEAD=$(basename "$(git --git-dir="$SRCDIR/.git" symbolic-ref HEAD 2>/dev/null)") || true
	PKGREMOTE=$(git --git-dir="$SRCDIR/.git" config "branch.${PKGHEAD:-master}.remote" 2>/dev/null) || true
	PKGURL=$(git --git-dir="$SRCDIR/.git" config "remote.${PKGREMOTE:-origin}.url")
	PKGREV=$(git --git-dir="$SRCDIR/.git" rev-parse HEAD)
	PKGDESC=$(
		git --git-dir="$SRCDIR/.git" describe "$PKGREV" 2>/dev/null ||
		git --git-dir="$SRCDIR/.git" describe --tags "$PKGREV" 2>/dev/null ||
		git --git-dir="$SRCDIR/.git" describe --all --always "$PKGREV"
	)

	PKGVERSION=${PKGDESC##*/}
	PKGDIR=$PKGREPO/pkg/$PKGNAME
	BUILDDIR=$PKGDIR/build-$PKGVERSION
	DESTDIR=$PKGDIR/install-$PKGVERSION
	PKGSUBREPO=$PKGDIR/.git
}

pkgit() {
	[ -d "$PKGSUBREPO" ] || GIT_OBJECT_DIRECTORY="$PKGREPO/objects" setupSubRepo
	GIT_OBJECT_DIRECTORY="$PKGREPO/objects" git --git-dir="$PKGSUBREPO" "$@"
}

setupSubRepo() {
	git init --bare "$PKGSUBREPO"
	rm -rf "$PKGSUBREPO"/{hooks/*,objects}
	git --git-dir="$PKGSUBREPO" symbolic-ref HEAD "refs/heads/$PKGNAME"
}

priorBuild() {
	echo "## prior build script from $(pkgit symbolic-ref HEAD)"
	echo "##"
	pkgit show HEAD -s --pretty='commit %h%d%ntree %t%nAuthored by %an <%ae> at %ai%nCommitted by %cn <%ce> at %ci%nSubject: %B' \
	| awk 'BEGIN { prefix="## " }; { print prefix $0; if (match($0, "Script:") == 1) {prefix=""} }'
	echo ""
	echo "## NOTE: you may add any number \`shell\` lines to drop into a shell within"
	echo "##       the build environment; any commands executed within it are captured"
	echo "##       for the final build script."
}

withBuild() {
	if [ -n "$PKGIT_DRYRUN" ]; then
		if [ "$1" == "bash" ] && [ $# -eq 2 ]; then
			echo cd "$BUILDDIR" '&& {'
			sed -e 's/^/  /' "$2"
			echo '}'
		else
			echo cd "$BUILDDIR" '&&' "$@"
		fi
		return
	fi
	export BUILDDIR DESTDIR PKGNAME PKGREPO PKGVERSION PREFIX SRCDIR
	mkdir -p "$BUILDDIR"
	cd "$BUILDDIR"
	"$@"
}

commitMess() {
	cat <<EOM
Built $PKGVERSION

Source: $SRCDIR
Upstream: $PKGURL
Revision: $PKGREV

Script:
$(grep -v '^##' "$PKGDIR/build.bash")

# Diff Stat:
$(pkgit diff --cached --stat | sed -e 's/^/# /')
EOM
}

historyBuild() {
	cat <<EOM
# Session shell history:
# TODO: curate this, as it will be used as a rebuild script later!
$(if [ -f "$PKGDIR/history.prior" ]; then
	diff "$PKGDIR/history"{.prior,} | grep '^> ' | cut -c 3-
else
	cat -u "$PKGDIR/history"
fi)
EOM
}

doBuild() {
	if [ -n "$PKGIT_DRYRUN" ]; then
		echo "Dry Run Build Variables:"
		dumpVars
	fi

	prior=$1

	[ -d "$PKGDIR" ] || mkdir -p "$PKGDIR"

	if [ -z "$prior" ] && pkgit rev-parse --verify -q HEAD >/dev/null; then
		priorBuild >"$PKGDIR/prior_build.bash"
		prior="$PKGDIR/prior_build.bash"
	fi

	steps=()

	if [ -n "$prior" ]; then
		cp "$prior" "$PKGDIR/build.bash"
		"$EDITOR" "$PKGDIR/build.bash"

		pushd "$PKGDIR"
		rm -f build.*.bash
		awk -f - build.bash <<- EOA
			BEGIN {n=0; of="build.0.bash"} {
				if (match(\$0, "shell") == 1) {of=sprintf("build.%d.bash", ++n); print "" > of}
				else if (match(\$0, "##") != 1) {print > of} }
			EOA
		popd

		i=0
		while [ -f "$PKGDIR/build.$i.bash" ]; do
			steps+=("$PKGDIR/build.$i.bash")
			i=$(( i + 1 ))
		done
	fi

	if [ -f "$PKGDIR/history" ]; then
		cp "$PKGDIR/history"{,.prior}
	fi

	i=0
	for step in "${steps[@]}"; do
		if [ $i -gt 0 ]; then
			doInteract
		fi
		cat "$step" >> "$PKGDIR/history"
		withBuild bash "$step" 2>&1 | tee "$PKGDIR/build.log"
		i=$(( i + 1 ))
	done
	if [ $i -eq 0 ]; then
		doInteract
	fi

	tag=$PKGNAME-$PKGVERSION
	if [ -n "$PKGIT_DRYRUN" ]; then
		echo "# would add, commit, and tag $tag"
	else
		historyBuild >"$PKGDIR/build.bash"
		cd "$DESTDIR/$PREFIX"
		GIT_WORK_TREE="$DESTDIR/$PREFIX" pkgit add .
		commitMess | GIT_WORK_TREE="$DESTDIR/$PREFIX" pkgit commit -e -F -
		git --git-dir="$PKGREPO" tag -f "$tag" "$(pkgit rev-parse HEAD)"
	fi
}

doInteract() {
	if [ -n "$PKGIT_DRYRUN" ]; then
		echo "# would drop into build shell"
		return
	fi
	echo "Dropping into build shell, salient variables:"
	dumpVars
	echo "NOTE: prior build commands are available in history"
	HISTFILE="$PKGDIR/history" withBuild bash
}

dumpVars() {
	{
		echo "  VAR=description=value"
		echo "  SRCDIR=Package Source Directory=$SRCDIR"
		echo "  PKGNAME=Package Name=$PKGNAME"
		echo "  PKGVERSION=Package Version=$PKGVERSION"
		echo "  BUILDDIR=Build Scratch Directory=$BUILDDIR"
		echo "  PREFIX=Target Installation Directory=$PREFIX"
		echo "  DESTDIR=Install Destination Directory=$DESTDIR"
	} | column -ts=
}

PKGROOT=$(dirname "$0")
if [[ $PKGROOT = */bin ]]; then
	PKGROOT=${PKGROOT%/bin}
fi
if [ "$PKGROOT" = "$HOME" ]; then
	PKGROOT=$HOME/.local
fi

PKGREPO=$PKGROOT/.git
if ! [ -d "$PKGREPO" ]; then
	git init --bare "$PKGREPO"
	rm -f "$PKGREPO"/hooks/*.hook
fi

case "$1" in
install)
	shift
	if [ $# -eq 0 ]; then
		inspectPackage "$(pwd)"
	else
		die "UNIMPLEMENTED install package by name; only works from within package source tree for now"
	fi
	ref=$(pkgit rev-list HEAD \
		| git --git-dir="$PKGREPO" name-rev --tags --name-only --stdin \
		| grep -v undefined | head -n1)
	cd "$PKGROOT"
	git --git-dir="$PKGREPO" merge --allow-unrelated-histories --no-edit "$ref"
	echo
	git --git-dir="$PKGREPO" show -s --pretty=oneline --no-decorate
	exit 0
	;;

repogit)
	shift
	cd "$PKGROOT"
	git --git-dir="$PKGREPO" "$@"
	exit 0
	;;
esac

inspectPackage "$(pwd)"

case "$1" in
build-script)
	priorBuild
	;;

build)
	shift
	doBuild "$@"
	;;

rm)
	rm -rf "$PKGDIR"
	;;

clean)
	rm -rf "$BUILDDIR" "$DESTDIR"
	;;

*)
	if [ $# -gt 0 ]; then
		pkgit "$@"
	else
		doBuild
	fi
	;;
esac
